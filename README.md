﻿﻿﻿﻿﻿﻿﻿# Shared Memory Dictionary

### 共享内存字典



一句话来描述就是：进程内的Redis

从事网络游戏后端开发十多年，一直都是在做有状态的服务，我们做事的逻辑是，玩家上线、加载玩家存档，玩家一边玩游戏，我们一边修改数据，最后玩家下线，存档，完毕。就是这样一个过程。

做着做着，我们发现一个情况，对于一些关系数据（比如工会、好友等）需要在服务器启动的时候加载到内存中，加载完毕玩家才能上线，要不然在玩家上线的时候去加载可能会卡一下。一方面增加了服务器的负担，一方面影响了玩家的体验。如果这些数据量比较大，达到几个G，加载过程可能会持续几分钟。也就意味着如果我们更新版本的时候，这段时间是处于停服状态。

现在我就在想，如果上线之后发现问题，然后更新版本，每次都这么久，玩家不乐意，如何解决这个问题？

有几种做法，一个是使用redis存储这些关系数据，服务器启动的时候redis不用重启。另外一种是使用共享内存。

使用Redis存储关系数据我是拒绝的，因为数据没在本地，在远端，要通过tcp网络传输，如果使用同步方式性能比较差，如果使用异步方式编程很麻烦。要特别注意时序问题。

共享内存貌似没有封装的比较好用的接口，至少我目前还没找到，如果你有麻烦推荐给我。

对于共享内存的封装方式，目前业界还是有蛮多的，直到今天我听华杉讲营销的时候他主张，要让接受成本最低。我就突然想到了用Redis的方式封装共享内存。于是就有了这个：

Share Memory Dictionary



### 基本特性

1. API类似Redis接口。会用Redis的人能迅速上手。
2. 使用共享内存存储数据，进程没了数据还在。
3. 提供多种容器（指针、数组、链表、哈希、红黑树等），以实现内存动态分配，接口类似STL。
4. 跨平台，Windows、Linux均可用。
5. 全头文件，拷贝即可使用。



### 适用场景

1. 有“热重启”（秒开）需求的进程，比如启动的时候需要从数据库加载大量数据。
2. 想进行“无感知更新”的进程。
3. 多个进程共享只读配置，想节约内存占用。



### 待办事项

| 编号 | 内容                                                         | 状态                      |
| ---- | ------------------------------------------------------------ | ------------------------- |
| 1    | ShmMap的删除接口erase有bug，和std::map的结果不一致           | 已修正，20200917，xinyong |
| 2    | ShmMap的erase接口需要有返回下一个元素的功能                  | 已修正，20200917，xinyong |
| 3    | 伙伴系统的内存分配算法只适合分配大块内存，系统需要另一种内存分配算法与之配合，以实现高效的小块内存分配 |                           |
| 4    | Windows平台下共享内存引用计数为0的时候会被操作系统回收，想想是否有比较好的解决方法 |                           |
| 5    | 目前一个进程只能使用一片共享内存，如果有多片的话，内存分配器就不支持了，想想是否有方法解决 |                           |
| 6    | Hash表的扩容可以参考一下redis的做法，分多次完成，避免卡顿    |                           |
| 7    | 考虑下直接复用nginx的各个容器                                |                           |
| 8    | 接口和数据成员的接口类型（主要是各种整数）需要优化下，消除警告 |                           |
| 9    | 增加std::array数据类型                                       |                           |
| 10   | 要尽量避免因为进程崩溃而生成的脏数据（中间状态），参考文件系统的一些做法 |                           |
| 11   | 参考下：https://github.com/Eospp/Eospp                       |                           |
|      |                                                              |                           |
|      |                                                              |                           |



### 操作备忘

查看共享内存，使用命令ipcs：

```
$ ipcs -m
```

删除共享内存，使用命令ipcrm：

```
$ ipcrm -m [shmid]
```

删除所有的共享内存，使用命令：

```
$ ipcrm -a
```





## 求star

您的支持是我前进的动力



## 联系我们

群名称：后端技术爱好者交流群

群号码：915372354

点击链接加入群聊【后端技术爱好者交流群】：https://jq.qq.com/?_wv=1027&k=GXi07Vh6



Will

